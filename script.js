const SHEET_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vSkDKqQuhfgBlDD1kWHOYg9amAZmDBCQCi3o-eT4HramTOY-PLelbGPCrEMcKd4I6PWu4L_BFGIhREy/pub?output=tsv',EUR_PER_CREDIT=40;let userCredits=0,leadsData=[],cart=[],currentTab='Lead',filters={Regione:'',Città:'',Categoria:'',Tipo:''};window.addEventListener('DOMContentLoaded',()=>{fetchData();initEventListeners();});function fetchData(){fetch(SHEET_URL).then(r=>r.text()).then(t=>{const o=t.trim().split('\n').map(e=>e.split('\t')),n=o.shift();leadsData=o.map(e=>Object.fromEntries(e.map((t,i)=>[n[i],t]))),initFilters(),renderCards();});}function initEventListeners(){document.querySelectorAll('.tab-button').forEach(e=>{e.addEventListener('click',()=>{currentTab=e.dataset.tab,document.querySelectorAll('.tab-button').forEach(t=>t.classList.remove('active')),e.classList.add('active'),renderCards();});});['Regione','Città','Categoria','Tipo'].forEach(t=>{document.getElementById(`filter-${t.toLowerCase()}`).addEventListener('change',e=>{filters[t]=e.target.value,'Regione'===t&&updateDependentFilters(),renderCards();});});document.getElementById('checkout').addEventListener('click',showPaymentInfo);}function initFilters(){populateSelect('filter-region',getUnique('Regione')),updateDependentFilters();}function updateDependentFilters(){['Città','Categoria','Tipo'].forEach(e=>{populateSelect(`filter-${e.toLowerCase()}`,[...new Set(leadsData.filter(t=>!filters.Regione||t.Regione===filters.Regione).map(t=>t[e]))]);});}function populateSelect(e,t){document.getElementById(e).innerHTML=`<option value="">Tutti</option>${t.map(e=>`<option value="${e}">${e}</option>`).join('')}`}function renderCards(){const e=document.getElementById('cards');e.innerHTML='';let t=leadsData.filter(e=>applyAllFilters(e));if('Tutti'!==currentTab){const n={Appuntamento:'Appuntamento',Contratto:'Contratto',Lead:'Lead'};t=t.filter(e=>e.Tipo===n[currentTab]||'Lead'===currentTab&&e.Tipo==='Lead')}t.forEach(e=>{const t=parseInt(e['Costo (crediti)'],10),n=document.createElement('div');n.className=`card ${getColorClass(e.Tipo)}`,n.innerHTML=`<div><h3>${e.Descrizione}</h3><p>${e.Città}, ${e.Regione}</p><p>Budget: €${e['Budget (€)']} - ${t} crediti</p></div><button class="round-button ${getColorClass(e.Tipo)}" onclick="addToCart(${t})">${'Contratto'===e.Tipo?'Riserva':`Acquisisci (+${t})`}</button>`,e.Tipo&&n.querySelector('button').classList.add(getColorClass(e.Tipo)),e.appendChild||null,document.getElementById('cards').appendChild(n)}),updateCartUI();}function applyAllFilters(e){return Object.keys(filters).every(t=>!filters[t]||e[t]===filters[t])}function getUnique(e){return[...new Set(leadsData.map(t=>t[e]))]}function getColorClass(e){return{'Lead':'blue','Appuntamento':'fuchsia','Contratto':'yellow'}[e]||'green'}function addToCart(e){cart.push(e),userCredits+=e,updateCartUI()}function removeFromCart(e){userCredits-=cart[e],cart.splice(e,1),updateCartUI()}function updateCartUI(){const e=document.getElementById('cart-items');e.innerHTML='',cart.forEach((t,n)=>{e.innerHTML+=`<li>+${t} crediti <button onclick="removeFromCart(${n})">×</button></li>`}),document.getElementById('cart-total').innerText=`Totale: ${userCredits} crediti (€${userCredits*EUR_PER_CREDIT})`}function showPaymentInfo(){alert(`Per pagare ${userCredits} crediti (totale €${userCredits*EUR_PER_CREDIT}):\nIBAN: LT67 3250 0328 0923 7250 (Revolut Bank UAB)\nBIC: REVOLT21\n\nOppure usa PayPal tramite il pulsante.`)}window.paypal?.Buttons({createOrder:(e,t)=>t.order.create({purchase_units:[{amount:{value:(userCredits*EUR_PER_CREDIT).toString()}}]}),onApprove:(e,t)=>t.order.capture().then(e=>alert('Pagamento completato da '+e.payer.name.given_name))}).render('#paypal-button-container');